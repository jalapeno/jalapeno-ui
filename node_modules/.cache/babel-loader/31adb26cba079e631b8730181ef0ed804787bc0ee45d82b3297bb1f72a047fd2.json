{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nvar shortestpaths_1 = require(\"./shortestpaths\");\nvar descent_1 = require(\"./descent\");\nvar rectangle_1 = require(\"./rectangle\");\nvar linklengths_1 = require(\"./linklengths\");\nvar Link3D = function () {\n  function Link3D(source, target) {\n    this.source = source;\n    this.target = target;\n  }\n  Link3D.prototype.actualLength = function (x) {\n    var _this = this;\n    return Math.sqrt(x.reduce(function (c, v) {\n      var dx = v[_this.target] - v[_this.source];\n      return c + dx * dx;\n    }, 0));\n  };\n  return Link3D;\n}();\nexports.Link3D = Link3D;\nvar Node3D = function () {\n  function Node3D(x, y, z) {\n    if (x === void 0) {\n      x = 0;\n    }\n    if (y === void 0) {\n      y = 0;\n    }\n    if (z === void 0) {\n      z = 0;\n    }\n    this.x = x;\n    this.y = y;\n    this.z = z;\n  }\n  return Node3D;\n}();\nexports.Node3D = Node3D;\nvar Layout3D = function () {\n  function Layout3D(nodes, links, idealLinkLength) {\n    var _this = this;\n    if (idealLinkLength === void 0) {\n      idealLinkLength = 1;\n    }\n    this.nodes = nodes;\n    this.links = links;\n    this.idealLinkLength = idealLinkLength;\n    this.constraints = null;\n    this.useJaccardLinkLengths = true;\n    this.result = new Array(Layout3D.k);\n    for (var i = 0; i < Layout3D.k; ++i) {\n      this.result[i] = new Array(nodes.length);\n    }\n    nodes.forEach(function (v, i) {\n      for (var _i = 0, _a = Layout3D.dims; _i < _a.length; _i++) {\n        var dim = _a[_i];\n        if (typeof v[dim] == 'undefined') v[dim] = Math.random();\n      }\n      _this.result[0][i] = v.x;\n      _this.result[1][i] = v.y;\n      _this.result[2][i] = v.z;\n    });\n  }\n  ;\n  Layout3D.prototype.linkLength = function (l) {\n    return l.actualLength(this.result);\n  };\n  Layout3D.prototype.start = function (iterations) {\n    var _this = this;\n    if (iterations === void 0) {\n      iterations = 100;\n    }\n    var n = this.nodes.length;\n    var linkAccessor = new LinkAccessor();\n    if (this.useJaccardLinkLengths) linklengths_1.jaccardLinkLengths(this.links, linkAccessor, 1.5);\n    this.links.forEach(function (e) {\n      return e.length *= _this.idealLinkLength;\n    });\n    var distanceMatrix = new shortestpaths_1.Calculator(n, this.links, function (e) {\n      return e.source;\n    }, function (e) {\n      return e.target;\n    }, function (e) {\n      return e.length;\n    }).DistanceMatrix();\n    var D = descent_1.Descent.createSquareMatrix(n, function (i, j) {\n      return distanceMatrix[i][j];\n    });\n    var G = descent_1.Descent.createSquareMatrix(n, function () {\n      return 2;\n    });\n    this.links.forEach(function (_a) {\n      var source = _a.source,\n        target = _a.target;\n      return G[source][target] = G[target][source] = 1;\n    });\n    this.descent = new descent_1.Descent(this.result, D);\n    this.descent.threshold = 1e-3;\n    this.descent.G = G;\n    if (this.constraints) this.descent.project = new rectangle_1.Projection(this.nodes, null, null, this.constraints).projectFunctions();\n    for (var i = 0; i < this.nodes.length; i++) {\n      var v = this.nodes[i];\n      if (v.fixed) {\n        this.descent.locks.add(i, [v.x, v.y, v.z]);\n      }\n    }\n    this.descent.run(iterations);\n    return this;\n  };\n  Layout3D.prototype.tick = function () {\n    this.descent.locks.clear();\n    for (var i = 0; i < this.nodes.length; i++) {\n      var v = this.nodes[i];\n      if (v.fixed) {\n        this.descent.locks.add(i, [v.x, v.y, v.z]);\n      }\n    }\n    return this.descent.rungeKutta();\n  };\n  Layout3D.dims = ['x', 'y', 'z'];\n  Layout3D.k = Layout3D.dims.length;\n  return Layout3D;\n}();\nexports.Layout3D = Layout3D;\nvar LinkAccessor = function () {\n  function LinkAccessor() {}\n  LinkAccessor.prototype.getSourceIndex = function (e) {\n    return e.source;\n  };\n  LinkAccessor.prototype.getTargetIndex = function (e) {\n    return e.target;\n  };\n  LinkAccessor.prototype.getLength = function (e) {\n    return e.length;\n  };\n  LinkAccessor.prototype.setLength = function (e, l) {\n    e.length = l;\n  };\n  return LinkAccessor;\n}();","map":{"version":3,"names":["shortestpaths_1","require","descent_1","rectangle_1","linklengths_1","Link3D","source","target","prototype","actualLength","x","_this","Math","sqrt","reduce","c","v","dx","exports","Node3D","y","z","Layout3D","nodes","links","idealLinkLength","constraints","useJaccardLinkLengths","result","Array","k","i","length","forEach","_i","_a","dims","dim","random","linkLength","l","start","iterations","n","linkAccessor","LinkAccessor","jaccardLinkLengths","e","distanceMatrix","Calculator","DistanceMatrix","D","Descent","createSquareMatrix","j","G","descent","threshold","project","Projection","projectFunctions","fixed","locks","add","run","tick","clear","rungeKutta","getSourceIndex","getTargetIndex","getLength","setLength"],"sources":["/Users/brucemcdougall/go/jalapeno-github/jalapeno-ui/node_modules/webcola/WebCola/src/layout3d.ts"],"sourcesContent":["import {Calculator} from './shortestpaths'\r\nimport {Descent} from './descent'\r\nimport {Projection, GraphNode, Rectangle} from './rectangle'\r\nimport {Variable} from './vpsc'\r\nimport {jaccardLinkLengths, LinkLengthAccessor} from './linklengths'\r\n\r\nexport class Link3D {\r\n        length: number;\r\n        constructor(public source: number, public target: number) { }\r\n        actualLength(x: number[][]) {\r\n            return Math.sqrt(\r\n                x.reduce((c: number, v: number[]) => {\r\n                    const dx = v[this.target] - v[this.source];\r\n                    return c + dx * dx;\r\n                }, 0));\r\n        }\r\n    }\r\n    export class Node3D implements GraphNode {\r\n        // if fixed, layout will not move the node from its specified starting position\r\n        fixed: boolean;\r\n        width: number;\r\n        height: number;\r\n        px: number;\r\n        py: number;\r\n        bounds: Rectangle;\r\n        variable: Variable;\r\n        constructor(\r\n            public x: number = 0,\r\n            public y: number = 0,\r\n            public z: number = 0) { }\r\n    }\r\n    export class Layout3D {\r\n        static dims = ['x', 'y', 'z'];\r\n        static k = Layout3D.dims.length;\r\n        result: number[][];\r\n        constraints: any[] = null;\r\n\r\n        constructor(public nodes: Node3D[], public links: Link3D[], public idealLinkLength: number = 1) {\r\n            this.result = new Array(Layout3D.k);\r\n            for (var i = 0; i < Layout3D.k; ++i) {\r\n                this.result[i] = new Array(nodes.length);\r\n            }\r\n            nodes.forEach((v, i) => {\r\n                for (var dim of Layout3D.dims) {\r\n                    if (typeof v[dim] == 'undefined') v[dim] = Math.random();\r\n                }\r\n                this.result[0][i] = v.x;\r\n                this.result[1][i] = v.y;\r\n                this.result[2][i] = v.z;\r\n            });\r\n        };\r\n\r\n        linkLength(l: Link3D): number {\r\n            return l.actualLength(this.result);\r\n        }\r\n\r\n        useJaccardLinkLengths: boolean = true;\r\n\r\n        descent: Descent;\r\n        start(iterations: number = 100): Layout3D {\r\n            const n = this.nodes.length;\r\n\r\n            var linkAccessor = new LinkAccessor();\r\n\r\n            if (this.useJaccardLinkLengths)\r\n                jaccardLinkLengths(this.links, linkAccessor, 1.5);\r\n\r\n            this.links.forEach(e => e.length *= this.idealLinkLength);\r\n\r\n            // Create the distance matrix that Cola needs\r\n            const distanceMatrix = (new Calculator(n, this.links,\r\n                e=> e.source, e=> e.target, e => e.length)).DistanceMatrix();\r\n\r\n            const D = Descent.createSquareMatrix(n, (i, j) => distanceMatrix[i][j]);\r\n\r\n            // G is a square matrix with G[i][j] = 1 iff there exists an edge between node i and node j\r\n            // otherwise 2.\r\n            var G = Descent.createSquareMatrix(n, function () { return 2 });\r\n            this.links.forEach(({ source, target }) => G[source][target] = G[target][source] = 1);\r\n\r\n            this.descent = new Descent(this.result, D);\r\n            this.descent.threshold = 1e-3;\r\n            this.descent.G = G;\r\n            //let constraints = this.links.map(e=> <any>{\r\n            //    axis: 'y', left: e.source, right: e.target, gap: e.length*1.5\r\n            //});\r\n            if (this.constraints)\r\n                this.descent.project = new Projection(<GraphNode[]>this.nodes, null, null, this.constraints).projectFunctions();\r\n\r\n            for (var i = 0; i < this.nodes.length; i++) {\r\n                var v = this.nodes[i];\r\n                if (v.fixed) {\r\n                    this.descent.locks.add(i, [v.x, v.y, v.z]);\r\n                }\r\n            }\r\n\r\n            this.descent.run(iterations);\r\n            return this;\r\n        }\r\n\r\n        tick(): number {\r\n            this.descent.locks.clear();\r\n            for (var i = 0; i < this.nodes.length; i++) {\r\n                var v = this.nodes[i];\r\n                if (v.fixed) {\r\n                    this.descent.locks.add(i, [v.x, v.y, v.z]);\r\n                }\r\n            }\r\n            return this.descent.rungeKutta();\r\n        }\r\n    }\r\n\r\n    class LinkAccessor implements LinkLengthAccessor<any> {\r\n        getSourceIndex(e: any): number { return e.source; }\r\n        getTargetIndex(e: any): number { return e.target; }\r\n        getLength(e: any): number { return e.length; }\r\n        setLength(e: any, l: number) { e.length = l; }\r\n    }\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}